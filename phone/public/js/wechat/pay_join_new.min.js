var craditCheckErr = 0;
function isMobile(a) {
    a = removeAllSpace(a);
    var b = a.length;
    return (a != "" && b == 11 && /^([0-9]{11})$/.test(a))
}
$(document).on("blur", ".mobileInput",
    function (a) {
        checkMobile($(this), false)
    });

function removeAllSpace(a) {
    return a.replace(/\s+/g, "")
}

function checkMobile(c, b) {
    var a = isMobile(c.val());
    if (!a) {
        popLayer({
            title: "温馨提示",
            btnsName: "返回",
            btnsCallback: "closePopLayerAndFocusError(" + c.attr("id") + "," + b + ")",
            content: "您输入的手机号码有误，请仔细检查核对！",
        });
        return false
    } else {
        c.removeClass("error")
    }
    return true
}

function checkIdCard(d, b) {
    var c = d.parent().prev().find(".idcardtype").val();
    if (c == 1) {
        var a = isIdCardNo(d.val());
        if (!a) {
            popLayer({
                title: "温馨提示",
                btnsName: "返回",
                btnsCallback: "closePopLayerAndFocusError(" + d.attr("id") + "," + b + ")",
                content: "您输入的证件号有误，请仔细检查核对！",
            });
            return false
        } else {
            d.removeClass("error")
        }
    }
    return true
}

function closePopLayerAndFocusError(b, a) {
    closePopLayer();
    $(b).addClass("error");
    if (a) {
        b.focus()
    }
}

var nowCheckInput = "";
$(document).on("blur", ".realname, #newContactName",
    function (b) {
        var a = $(this).val();
        checkInput(a, this)
    });
$(document).on("blur", ".idCardInput",
    function (d) {
        if (!checkIdCard($(this), false)) {
            return false
        }
        var b = $(this).val();
        if (!checkIdCardInput2(b, this)) {
            return false
        }
        var a = $(this).parent().parent().find(".idcardtype").val();
        if (a != 1) {
            return false
        }
        var c = b.substr(6, 4) + "-" + b.substr(10, 2) + "-" + b.substr(12, 2);
        checkNeedGuardian(c, this);
        checkVipDiscount(b, this)
    });

function checkIdCardInput2(d, c) {
    nowCheckInput = c;
    var b = new RegExp("[，。？！、：；……“”‘’（）《》｛｝［］～——·＃＊|〖〗【】『』〔〕「」]");
    var a = $(c).attr("class");
    if (b.test(d) && d != "") {
        popLayer({
            title: "温馨提示",
            btnsName: "返回",
            btnsCallback: "closePopLayerAndFocus()",
            content: "证件类型不能含有 （）【】“”‘’；：。，、？等特殊中文符号，请重新输入！",
        });
        $(c).addClass("error");
        return false
    }
    $(c).removeClass("error");
    return true
}

function checkInput(d, c) {
    nowCheckInput = c;
    var b = new RegExp("[\"%`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（）&—|{}【】‘；：”“'。，、？]");
    var a = $(c).attr("class");
    if (b.test(d) && d != "" && a != "birthday valid") {
        popLayer({
            title: "温馨提示",
            btnsName: "返回",
            btnsCallback: "closePopLayerAndFocus()",
            content: '输入框内不能含有 ?!:"()% 等特殊符号，请重新输入！',
        });
        $(c).addClass("error");
        return false
    }
    $(c).removeClass("error");
    return true
}

function closePopLayerAndFocus() {
    closePopLayer();
    $(nowCheckInput).focus()
}

$("#changyong").click(function () {
    window.history.pushState("choice", null, "");
    changeContent()
});
$(document).on("click", "#addContact",
    function (a) {
        $(this).css("display", "none");
        $("#newContact").css("display", "inherit");
        $(".contact-li").hide();
        $("#mt").html("正在新增...");
        $("#mte").hide();
        $("#hideMemberBtn").hide();
        $("#hideAddMemberBtn").show();
        if (contactCount <= 0) {
            $("#mte").attr("data-ise", "1");
            $("#mte").html("完成");
            $("#mt").html("正在编辑...")
        }
        $(".topBar p").html("新增常用人")
    });
$(window).on("popstate",
    function () {
        changeContent()
    });

function changeContent() {
    var a = window.history.state;
    if (a == "choice") {
        $("#join-content").hide();
        $("#my_member").show();
        $(".topBar p").html("插入常用人")
    } else {
        if (a == "home" || a == null) {
            $("#join-content").show();
            $("#my_member").hide();
            $(".topBar p").html("填写报名信息");
            hideAddMember();
            $("#mte").attr("data-ise", "0");
            $("#mte").html("编辑");
            $("#mt").html("勾选插入常用人信息");
            $(".mm_check").each(function (c, d) {
                var e = $(d).attr("data-val");
                var b = $(d).children().attr("data-select");
                $(d).attr("onclick", "selectMember($(this));");
                $(d).children().attr("class", b)
            });
            $("#addContact").css("display", "none");
            if (contactCount <= 0) {
                $("#addContact").css("display", "inherit");
                $("#newContact").css("display", "none")
            }
        }
    }
}

function hideMember() {
    $(".edit-contact-btn").hide();
    window.history.pushState("home", null, "");
    changeContent()
}

function hideAddMember() {
    $("#newContactId").val(0);
    $("#newContactName").val("");
    $("#showContactIdentityType").html('身份证 <img src="/phone/public/images/wechat/select_arrow.png" width="10">');
    $("#newContactIdentityType").val(1);
    $("#newContactIdentity").val("");
    $("#newContactIdentity").addClass("isIdCardNo");
    $("#newContactBirthday").val("");
    $(".newContactSexRadio input[type='radio']").prop("checked", false);
    $("#newContactTel").val("");
    $("#newContact").css("display", "none");
    $(".contact-li").show();
    $("#mt").html("正在编辑...");
    $("#mte").show();
    $("#hideMemberBtn").show();
    $("#hideAddMemberBtn").hide();
    $(".topBar p").html("插入常用人")
}

function editContact(b) {
    var a = contactsById[b];
    $("#newContactId").val(a.contactId);
    $("#newContactName").val(a.realName);
    $("#showContactIdentityType").html($("#newContactIdentityType option[value=" + a.identity_type + "]").html() + ' <img src="/phone/public/images/wechat/select_arrow.png" width="10">');
    $("#newContactIdentityType").val(a.identity_type);
    if (a.identity_type != 1) {
        $("#newContactIdentity").removeClass("isIdCardNo")
    }
    $("#newContactIdentity").val(a.identity);
    $("#newContactBirthday").val(a.birthday_str);
    $(".newContactSexRadio input[type='radio'][value=" + a.sex + "]").prop("checked", "checked");
    $("#newContactTel").val(a.telephone);
    $("#addContact").click()
}

var payData = "";

function previewImages(a) {
    wx.previewImage({
        current: a,
        urls: [a]
    })
}

var idcardArr = new Array();
var idcardKey = 0;

function checkIdCardInput(d) {
    var c = $(d).attr("idType");
    if (c == 1 || c == 2) {
        var a = $(d).parent().parent().prev().find("input").val();
        var b = d.value;
        if (!checkAge(a, b)) {
            $(d).parent().parent().prev().prev().find("input").val("");
            $(d).parent().parent().next().next().find("input").val("");
            d.value = ""
        } else {
            if (isIdCardNo(b)) {
                $("#new_user_num").val(0);
                $("#activity-fee-list .new-user-discount .pull-left:last span").html(0);
                $("#child_num").val(0);
                $("#activity-fee-list .child-discount .pull-left:last span").html(0);
                $(".idCardInput").each(function (e, f) {
                    checkIdCardIsset($(this).val())
                })
            }
        }
    }
    return
}

function checkAgeIsChildByIdcard(b, e) {
    if (e == 1) {
        var f = parseInt(b.substr(6, 4))
    } else {
        if (e == 2) {
            var f = parseInt(b.substr(0, 4))
        }
    }
    var c = new Date();
    var d = parseInt(c.getFullYear());
    var a = d - f;
    if (haveChildDiscount) {
        if (a < discountAge) {
            return true
        }
    }
    return false
}

function checkIdCardIsset(d) {
    var a = false;
    if (idcardArr.length > 0) {
        var c = 1;
        for (var b = 0; b < idcardArr.length; b++) {
            if (idcardArr[b]["idcard"] == d) {
                a = true;
                c = idcardArr[b]["isset"]
            }
        }
        if (c == 0) {
            var e = $("#new_user_num").val();
            e++;
            $("#new_user_num").val(e);
            $("#activity-fee-list .new-user-discount .pull-left:last span").html(e);
            countActivityMoney();
            return
        }
    }
    if (!a) {
        $.ajax({
            url: "/wechat/pay/checkisnewuser",
            type: "POST",
            dataType: "json",
            data: {
                idcard: d,
                oid: oid
            },
            success: function (f) {
                idcardArr[idcardKey] = new Array();
                idcardArr[idcardKey]["idcard"] = d;
                idcardArr[idcardKey]["isset"] = f.isset;
                idcardKey++;
                if (f.isset == 0) {
                    var g = $("#new_user_num").val();
                    g++;
                    $("#new_user_num").val(g);
                    $("#activity-fee-list .new-user-discount .pull-left:last span").html(g);
                    countActivityMoney()
                }
            }
        })
    }
}

function checkAge(c, e) {
    return true;
    if (min_age == 0 && max_age == 0) {
        return true
    }
    var f = parseInt(e.substr(6, 4));
    var b = new Date();
    var d = parseInt(b.getFullYear());
    var a = d - f;
    if (a < min_age || a > max_age) {
        alert("十分抱歉！" + c + "的年龄不适合参与本次活动，请咨询领队！");
        return false
    }
    return true
}

var card;
var membernum = mySignInfoCount;
var tmp_num = mySignInfoCount;
var wxparams;
var notFixdata;
$(document).on("click", "#payBtn",
    function (a) {
        $(".loading").html("处理中...");
        $("#loading").show();
        $("#payBtn").attr("disabled", "disabled");
        setTimeout("doSubmit()", 100)
    });

function doSubmit() {
    $("#form").submit()
}

function checkCardAge() {
    if (typeof(card) != "undefined" && card.hasOwnProperty("age")) {
        if (card.age > 0) {
            var d = $(".idCardInput");
            if (d.length > 0) {
                var a = new Date();
                var f = parseInt(a.getFullYear());
                var e = false;
                for (var b = 0; b < d.length; b++) {
                    var g = $(d[b]).attr("idType");
                    if (g == 1 || g == 2) {
                        var j = $(d[b]).val();
                        var h = parseInt(j.substr(6, 4));
                        if (f - h <= card.age) {
                            return true
                        }
                    } else {
                        var k = $.trim($($(".birthday")[b]).val());
                        if (k) {
                            var c = k.split("-")[0];
                            if (c < f || c > (f - 100)) {
                                if (f - c <= card.age) {
                                    return true
                                }
                            }
                        }
                    }
                }
                if (e) {
                    return true
                } else {
                    popLayer({
                        title: "温馨提示",
                        btnsName: "返回",
                        btnsCallback: "closePopLayer()",
                        content: "十分抱歉！订单需要添加年龄小于" + card.age + "岁的用户才能使用该卡券。",
                    });
                    return false
                }
            } else {
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: "十分抱歉！订单需要添加年龄小于" + card.age + "岁的用户才能使用该卡券。",
                });
                return false
            }
        }
    }
    return true
}

$().ready(function () {
    $("#marshal-point").change(function () {
        $("#marshal-point-ui li").css("border", "none");
    });
    $("#form").validate({
        ignore: "",
        submitHandler: function (a) {
            var l = false;
            
            if ($('input[type="radio"][name="paytype"]:checked').length <= 0) {
                $("html,body").scrollTop($("#paytype-ul").offset().top);
                $("#paytype-ul").css("border", "1px solid #FF6633");
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: "请选择您的支付方式",
                });
                l = true
            }

            if ($("#marshal-point").val() <= 0) {
                $("html,body").scrollTop($("#paytype-ul").offset().top);
                $("#marshal-point-ui li").css("border", "1px solid #FF6633");
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: "请选择您的集合地点",
                });
                l = true
            }

            $(".idCardInput").each(function (o, p) {
                var n = checkIdCard($(this), true);
                if (!n) {
                    l = true
                }
            });
            $(".mobileInput").each(function (o, p) {
                var n = checkMobile($(this), true);
                if (!n) {
                    l = true
                }
            });
            $(".realname").each(function (o, p) {
                var n = $(this).val();
                if (!checkInput(n, this)) {
                    l = true
                }
            });
            $(".traffic").each(function (n, o) {
                if ($(this).val() == 0) {
                    popLayer({
                        title: "温馨提示",
                        btnsName: "返回",
                        btnsCallback: "closePopLayer()",
                        content: $("#realname" + $(this).attr("signupnum")).val() + "未选择交通方式，请您按需要进行选择。系统将根据您的选择自动购票。",
                    });
                    l = true
                }
            });
            if (l) {
                $(".loading").html("");
                $("#loading").hide();
                $("#payBtn").removeAttr("disabled");
                return
            }
            if (!checkCardAge()) {
                $(".loading").html("");
                $("#loading").hide();
                $("#payBtn").removeAttr("disabled");
                return
            }
            if (isHK && !isaddservice) {
                var g = $(".signups").length;
                var c = 0;
                for (var h = 0; h < g; h++) {
                    var e = $(".signups").eq(h).find(".visag").is(":checked");
                    var m = $(".signups").eq(h).find(".visal").is(":checked");
                    var j = $(".signups").eq(h).find(".idcardtype").val();
                    if (!e && !m && j != 6 && j != 4) {
                        c++
                    }
                }
                if (c > 0) {
                    popLayer({
                        title: "温馨提示",
                        btnsName: "返回",
                        btnsCallback: "closePopLayer()",
                        content: "请选择您的签证类型！",
                    });
                    $(".loading").html("");
                    $("#loading").hide();
                    $("#payBtn").removeAttr("disabled");
                    return
                }
            }
            if (visagClickSignUps.length > 0) {
                var b = 0;
                $.each(visagClickSignUps,
                    function (o, p) {
                        var n = $("#visaImg" + visagClickSignUps[o]).val();
                        if (n == "") {
                            b++
                        }
                    })
            }
            var d = $("#mianze").is(":checked");
            if (!d) {
                $(".loading").html("");
                $("#loading").hide();
                $("#payBtn").removeAttr("disabled");
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回;我已阅读并同意",
                    btnsCallback: "closePopLayer();agreeTermsAndPay();",
                    content: '请先仔细阅读并同意<a href="javascript::void(0)" style="color: #9B8CE5; font-style: italic; text-decoration: underline;">《旅游服务协议》</a>！',
                });
                return
            }
            if (craditCheckErr > 0) {
                $(".loading").html("");
                $("#loading").hide();
                $("#payBtn").removeAttr("disabled");
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: "请检查分期付款银行卡号是否正确",
                });
                return
            }
            var f = $("#form").serialize();
            f = f + "&cardCode=" + encript_code;
            f = f + "&cardId=" + card_id;
            if (isaddservice) {
                $(".loading").html("购买中...")
            } else {
                $(".loading").html("报名中...")
            }
            $("#loading").show();
            $("#payBtn").attr("disabled", "disabled");
            $.ajax({
                url: "/phone/line/ajax_create",
                type: "POST",
                dataType: "json",
                data: f,
            }).done(function (o) {
                console.log(o);
                if (o.errcode != 0) {
                    $(".loading").html("");
                    $("#loading").hide();
                    $("#payBtn").removeAttr("disabled");
                    popLayer({
                        title: "温馨提示",
                        btnsName: "返回",
                        btnsCallback: "closePopLayer()",
                        content: o.errmsg,
                    })
                } else {
                    window.location.href = o.redirecturl
                }
            }).fail(function () {
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: "您好，系统繁忙中，请稍候操作！",
                })
            });
            return false
        },
        errorPlacement: function (a, b) {
            $(".loading").html("");
            $("#loading").hide();
            $("#payBtn").removeAttr("disabled");
            if (b.attr("id") == "mianze") {
                b.next().attr("class", "required check-error")
            }
        }
    })
});

function jsApiCall() {
    wx.ready(function () {
        console.log("WX ready...");
        WeixinJSBridge.invoke("getBrandWCPayRequest", wxparams,
            function (a) {
                $(".loading").html("");
                $("#loading").hide();
                if (a.err_msg == "get_brand_wcpay_request:ok") {
                    queryStatus()
                } else {
                    if (a.err_msg != "get_brand_wcpay_request:cancel") {
                        alert("err_code=" + a.err_code + ", err_desc=" + a.err_desc + ", err_msg=" + a.err_msg);
                        $("#payBtn").removeAttr("disabled")
                    } else {
                        $("#payBtn").removeAttr("disabled")
                    }
                }
            })
    })
}

function queryStatus() {
    $.ajax({
        type: "POST",
        data: {
            aid: aid,
            pc: payData
        },
        url: "/wechat/activity/querystatus",
        dataType: "json",
        success: function (a) {
            if (a.status == 1) {
                top.location.href = a.url
            }
        }
    })
}

function selectOtherJob(c, a) {
    if (c.value == -1) {
        var b = $(c).parent().parent().next().html();
        if (b == null) {
            str = '<li><div class="left">其他岗位</div><div class="right"><input id="job' + a + '" type="text" name="job' + a + '" placeholder="（必填）" class="required" /></div></li>';
            $(c).removeAttr("name");
            $(c).parent().parent().parent().append(str)
        }
    } else {
        $(c).attr("name", "job" + a);
        $(c).parent().parent().next().remove()
    }
}

function callpay() {
    if (typeof WeixinJSBridge == "undefined") {
        if (document.addEventListener) {
            document.addEventListener("WeixinJSBridgeReady", jsApiCall, false)
        } else {
            if (document.attachEvent) {
                document.attachEvent("WeixinJSBridgeReady", jsApiCall);
                document.attachEvent("onWeixinJSBridgeReady", jsApiCall)
            }
        }
    } else {
        jsApiCall()
    }
}

$("#num_select").change(function () {
    price();
    $("#member").html(" ");
    for (var a = 0; a < num; a++) {
        $("#member").append(fix_people(a, "", "", "", "", "", "", "", "", "", "", "", "", ""));
        $(".sexRadio").rdo();
        if (careIsDefalt) {
            $("#careJob" + a).click()
        }
    }
});
price();

function price() {
    var c = membernum;
    var a = parseFloat(money) * c;
    a -= (getCareNum() * careMoney);
    a = a.toFixed(2);
    if (typeof(card) != "undefined") {
        var b = card.least_cost / 100;
        if (a < b) {
            $("#cardselect").html('<img class="go" style="margin-top: -3px;" src="/phone/public/images/wechat/in.png">')
        }
    }
    $("#num").html(c);
    $("input[name='people_num']").val(tmp_num);
    $("#fee").html(a);
    countActivityMoney()
}

$("#sex_nav a").click(function () {
    $("#sex_nav a").removeClass();
    $(this).attr("class", "cur");
    var a = $(this).attr("val");
    $("#sex").val(a)
});

function addmember() {
    $("#member").append(fix_people(membernum, "", "", "", "", "", "", "", "", "", "", "", ""));
    $(".sexRadio").rdo();
    if (careIsDefalt) {
        $("#careJob" + membernum).click()
    }
    $("#birthday" + membernum).date("",
        function (a, b) {
            $(b).val(a);
            checkNeedGuardian(a, b)
        },
        function (a) {
        });
    membernum++;
    tmp_num++;
    price();
    if (isHK) {
        $(":radio").rdo()
    }
    if (!haveQuotaLimit) {
        countActivityMoney()
    }
    if (haveQuotaLimit) {
        addSignupDiscountNum();
        getNewQuotaLimitNum()
    }
}

$("#mte").click(function () {
    var a = $(this).attr("data-ise");
    if (a == 0) {
        $(this).attr("data-ise", "1");
        $(this).html("完成");
        $("#mt").html("正在编辑...");
        $(".mm_check").each(function (c, d) {
            var e = $(d).attr("data-val");
            var b = $(d).children().attr("class");
            $(d).attr("onclick", "delContact(" + e + ")");
            $(d).children().attr("class", "mem-delete");
            $(d).children().attr("data-select", b)
        });
        $("#addContact").css("display", "inherit");
        $(".edit-contact-btn").css("display", "inherit")
    } else {
        $(this).attr("data-ise", "0");
        $(this).html("编辑");
        $("#mt").html("勾选插入常用人信息");
        $(".mm_check").each(function (c, d) {
            var e = $(d).attr("data-val");
            var b = $(d).children().attr("data-select");
            $(d).attr("onclick", "selectMember($(this));");
            $(d).children().attr("class", b)
        });
        $("#addContact").css("display", "none");
        if (contactCount <= 0) {
            $("#addContact").css("display", "inherit");
            $("#newContact").css("display", "none")
        }
        $(".edit-contact-btn").css("display", "none")
    }
});
$("#newContactIdentityType").change(function (b) {
    var a = $(this).val();
    if (a == 1) {
        var c = "身份证";
        $(this).parent().parent().next().css("display", "none");
        $(this).parent().parent().next().next().css("display", "none");
        $(this).parent().parent().parent().parent().parent().css("height", "120px");
        $("#newContact div:last span").css("line-height", "120px");
        $("#newContactBirthday").val("");
        $(".newContactSexRadio label").removeClass("focus");
        $(".newContactSexRadio label").removeClass("on");
        $(".newContactSexRadio .newContactSex").removeAttr("checked");
        $("#newContactBirthday").removeClass("required");
        $("#newContactIdentity").addClass("isIdCardNo")
    } else {
        var c = $('#newContactIdentityType>option[value="' + a + '"]').text();
        $(this).parent().parent().next().css("display", "inherit");
        $(this).parent().parent().next().next().css("display", "inherit");
        $(this).parent().parent().parent().parent().parent().css("height", "200px");
        $("#newContact div:last span").css("line-height", "200px");
        $("#newContactBirthday").addClass("required");
        $("#newContactIdentity").removeClass("isIdCardNo")
    }
    $("#showContactIdentityType").html(c + ' <img width="10" src="/phone/public/images/wechat/select_arrow.png">')
});
$("#newContactBirthday").click(function (a) {
    $("#my_member").css("z-index", "1040")
});
$().ready(function () {
    $("#newContact form").validate({
        ignore: "",
        submitHandler: function (b) {
            var c = $("#newContact form").serialize();
            c += "&openId=" + wxoid;
            if ($("#newContactIdentityType").val() != 1) {
                var a = "";
                $(".newContactSex").each(function (d, e) {
                    if ($(this).is(":checked")) {
                        a = $(this).val()
                    }
                });
                if (a == "") {
                    popLayer({
                        title: "温馨提示",
                        btnsName: "返回",
                        btnsCallback: "closePopLayer()",
                        content: "请选择性别!",
                    });
                    return false
                }
            }
            $.ajax({
                url: "/phone/member/linkman/ajax_save?action=save",
                type: "POST",
                dataType: "json",
                data: c,
                success: function (e) {
                    $("#loading").hide();
                    if (e.status == 1) {
                        hideAddMember();
                        if (e.isEdit) {
                            contactsById[e.data.contactId] = e.data;
                            $("#li_" + e.data.contactId + " #n").html(e.data.realName);
                            $("#li_" + e.data.contactId + " #i").parent().html(e.data.identity_type_name + '：<span id="i">' + e.data.identity + "</span>");
                            $("#li_" + e.data.contactId + " #t").html(e.data.telephone);
                            $("#c_" + e.data.contactId).parent().attr("identity-type", e.data.identity_type);
                            var d = "";
                            if (e.data.birthday_str != undefined) {
                                d = e.data.birthday_str
                            }
                            $("#c_" + e.data.contactId).parent().attr("birthday", e.data.birthday_str);
                            $("#c_" + e.data.contactId).parent().attr("sex", e.data.sex)
                        } else {
                            contactCount++;
                            var f = '<li id="li_' + e.data.contactId + '" class="contact-li">';
                            f += '<div class="mm_info">';
                            f += '<div style="border-bottom: 1px solid #e9e9e9;">';
                            f += '姓名：<span id="n">' + e.data.realName + "</span>";
                            if (e.data.isdefault == 1) {
                                f += '<span id="sdf_c_' + e.data.contactId + '" data-val="' + e.data.contactId + '" class="df">默认</span>'
                            } else {
                                f += '<span id="sdf_c_' + e.data.contactId + '" data-val="' + e.data.contactId + '" class="sf purple" onclick="setDefault(' + e.data.contactId + ');" >设为默认</span>'
                            }
                            f += "</div>";
                            f += '<div style="border-bottom: 1px solid #e9e9e9;">' + e.data.identity_type_name + '：<span id="i">' + e.data.identity + "</span></div>";
                            f += '<div>电话号码：<span id="t">' + e.data.telephone + "</span></div>";
                            f += "</div>";
                            var d = "";
                            if (e.data.birthday_str != undefined) {
                                d = e.data.birthday_str
                            }
                            f += '<div pass-num="' + e.data.passNum + '" pass-addr="' + e.data.passAddr + '" pass-type="' + e.data.passType + '" data-val="' + e.data.contactId + '" identity-type="' + e.data.identity_type + '" birthday="' + d + '" sex="' + e.data.sex + '" class="mm_check" onclick="delContact(' + e.data.contactId + ')">';
                            f += '<span id="c_' + e.data.contactId + '" class="mem-delete" data-select="mem-unselect"></span>';
                            f += "</div>";
                            f += '<div class="clear"></div>';
                            f += "</li>";
                            $("#newContact").before(f)
                        }
                    } else {
                        popLayer({
                            title: "温馨提示",
                            btnsName: "确认",
                            btnsCallback: "closePopLayer()",
                            content: '<div class="text-center">' + e.msg + "</div>",
                        })
                    }
                }
            });
            return false
        },
        errorPlacement: function (a, b) {
            $(".loading").html("");
            $("#loading").hide();
            $(b).css("border", "1px solid #ff6633");
            $(b).css("border-radius", "3px")
        }
    })
});
$("#newContact form input").blur(function (b) {
    var d = $(this).attr("class");
    var c = d.split(" ");
    var a = false;
    $.each(c,
        function (e, f) {
            if (f == "error") {
                a = true
            }
        });
    if ($(this).val() == "") {
        a = true
    }
    if (a) {
        $(this).css("border", "1px solid #ff6633");
        $(this).css("border-radius", "3px")
    } else {
        $(this).css("border", "0");
        $(this).css("border-radius", "0")
    }
});
$(document).on("click", "#addNewContactBtn",
    function (a) {
        $(".loading").html("正在保存");
        $("#loading").show();
        $("#newContact form").submit()
    });

function reduceMember(a) {
    var b = a.prev().attr("for");
    if (typeof(b) != "undefined") {
        $("#" + b).attr("class", "mem-unselect")
    }
    reduceSignupDiscountNum();
    a.prev().remove();
    a.next().remove();
    a.remove();
    membernum--;
    price();
    countActivityMoney()
}

var last = 0;

function selectMember(w) {
    var q = w.children("span").attr("class");
    var z = w.prev().children().children("#n").html();
    var y = w.children("span").attr("id");
    var p = w.attr("identity-type");
    var n = w.attr("birthday");
    var l = w.attr("sex");
    var u = w.attr("pass-type");
    var h = w.attr("pass-num");
    var x = w.attr("pass-addr");
    if (q == "mem-unselect") {
        var t = w.prev().children().children("#i").html();
        var c = w.prev().children().children("#t").html();
        var o = w.prev().children().children("#t").children("a");
        if (p == 1 || p == 2) {
            if (!checkAge(z, t)) {
                return false
            }
        }
        w.children("span").attr("class", "mem-select");
        if (o != undefined) {
            var g = o.html();
            if (g != undefined && g != null && g != "") {
                c = o.html()
            }
        }
        var w;
        $(".realname").each(function (e, s) {
            if (s.value == "") {
                w = s;
                return false
            }
        });
        if (w.value == "" && typeof(w) != "undefined") {
            var j = $(w);
            var b = j.parent().parent().next().find(".idCardInput");
            var m = j.parent().parent().next().next().next().next().find(".mobileInput");
            var f = j.parent().parent().next().find(".idcardtype");
            var d = j.parent().parent().next().next().find(".birthday");
            var k = j.parent().parent().next().next().next().find(".sexRadio");
            var r = j.parent().parent().next().next().next().next().next().find(".visatype");
            var a = j.parent().parent().parent();
            if (p != 1) {
                d.parent().parent().css("display", "inherit");
                k.parent().parent().parent().css("display", "inherit")
            }
            a.attr("for", y);
            a.attr("id", "f_" + y);
            j.val(z + "");
            b.val(t);
            f.val(p);
            b.attr("idtype", p);
            f.prev().html(f.find(".type" + p).html() + '<img src="/phone/public/images/wechat/select_arrow.png" width="10">');
            m.val(c);
            d.val(n);
            k.each(function (e, s) {
                if ($(this).val() == l) {
                    $(this).prev().addClass("focus");
                    $(this).prev().addClass("on");
                    $(this).attr("checked", "checked")
                }
            });
            r.each(function (e, s) {
                if ($(this).val() == u) {
                    $(this).click();
                    $(this).parent().parent().parent().next().find(".passNum").val(h);
                    $(this).parent().parent().parent().next().find(".passAddr").val(x)
                }
            });
            if (!isHK || (isHK && (p == 4 || p == 6))) {
                j.parent().parent().parent().find(".visa-li").hide()
            } else {
                j.parent().parent().parent().find(".visa-li").show()
            }
            countActivityMoney();
            if (p == 1) {
                var v = t.substr(6, 4) + "-" + t.substr(10, 2) + "-" + t.substr(12, 2);
                checkNeedGuardian(v, $("#member .signups:last .idCardInput"))
            } else {
                checkNeedGuardian(n, $("#member .signups:last .birthday"))
            }
            checkVipDiscount(t, $("#member .signups:last .idCardInput"));
            return
        }
        $("#member").append(fix_people(membernum, z, t, p, c, y, "", "", u, h, x, n, l));
        $(".sexRadio").rdo();
        if (careIsDefalt) {
            $("#careJob" + membernum).click()
        }
        $("#birthday" + membernum).date("",
            function (e, s) {
                $(s).val(e);
                checkNeedGuardian(e, s)
            },
            function (e) {
            });
        if (p == 1) {
            var v = t.substr(6, 4) + "-" + t.substr(10, 2) + "-" + t.substr(12, 2);
            checkNeedGuardian(v, $("#member .signups:last .idCardInput"))
        } else {
            checkNeedGuardian(n, $("#member .signups:last .birthday"))
        }
        checkVipDiscount(t, $("#member .signups:last .idCardInput"));
        membernum++;
        tmp_num++;
        price();
        if (isHK) {
            $(":radio").rdo()
        }
        if (haveQuotaLimit) {
            addSignupDiscountNum();
            getNewQuotaLimitNum()
        }
    } else {
        if (q == "mem-select") {
            w.children("span").attr("class", "mem-unselect");
            $("#f_" + y).next().next().remove();
            $("#f_" + y).next().remove();
            $("#f_" + y).remove();
            reduceSignupDiscountNum();
            if ($(".add-btn").length >= 1) {
                $(".add-btn").eq(0).removeClass("red");
                $(".add-btn").eq(0).html("+ 增加报名人");
                $(".add-btn").eq(0).attr("id", "add-btn");
                $(".add-btn").eq(0).attr("onclick", "addmember()")
            } else {
                addmember();
                $(".add-btn").eq(0).removeClass("red");
                $(".add-btn").eq(0).html("+ 增加报名人");
                $(".add-btn").eq(0).attr("id", "add-btn");
                $(".add-btn").eq(0).attr("onclick", "addmember()");
                return
            }
            price()
        }
    }
}

function check_input(a) {
    var b = $("#realname" + parseInt(a));
    if (b.val() == "" || b.val() == undefined) {
        return true
    }
    return false
}

function fix_people(g, a, m, p, e, o, k, c, d, h, b, n, j) {
    var l = "";
    if (typeof(d) == "undefined") {
        d = 0
    }
    if (typeof(h) == "undefined") {
        h = ""
    }
    if (typeof(b) == "undefined") {
        b = ""
    }
    if (typeof(o) == "undefined") {
        l += '<ul data-index="' + g + '">'
    } else {
        l += '<ul id="f_' + o + '" for="' + o + '" class="signups" data-index="' + g + '">'
    }
    if (p == "") {
        p = 1
    }
    l += '<li><div class="left">真实姓名</div>';
    l += '<div class="right"><input id="realname' + g + '" type="text" name="realname' + g + '" placeholder="（与证件名字一致）" class="required realname" value="' + a + '" ';
    l += '/></div><div style="clear: both;"></div></li>';
    l += '<li><div class="left">';
    l += '<div class="select">';
    l += '<div class="select-show idcardSelect">';
    for (var f = 0; f < identityTypes.length; f++) {
        if (p == identityTypes[f].type) {
            l += identityTypes[f].name + '<img src="/phone/public/images/wechat/select_arrow.png" width="10">'
        }
    }
    l += "</div>";
    l += '<select id="idcardtype' + g + '" name="idcardtype' + g + '" signupnum="' + g + '" class="idcardtype" selectType="idcardtype">';
    for (var f = 0; f < identityTypes.length; f++) {
        l += '<option class="type' + identityTypes[f].type + '" value="' + identityTypes[f].type + '" ';
        if (p == identityTypes[f].type) {
            l += 'selected="selected"'
        }
        l += ">" + identityTypes[f].name + "</option>"
    }
    l += "</select>";
    l += "</div>";
    l += '</div><div class="right">';
    l += '<input id="idcard' + g + '" type="text" idType="' + p + '" name="idcard' + g + '" placeholder="（与证件号码一致）" onblur="checkIdCardInput( this );" class="idCardInput required" value="' + m + '" />';
    l += "</div></li>";
    if (p == 1) {
        l += '<li class="birthday-li" style="display:none;">'
    } else {
        l += '<li class="birthday-li">'
    }
    l += '<div class="left">出生日期</div>';
    l += '<div class="right">';
    l += '<input id="birthday' + g + '" class="birthday" type="text" name="birthday' + g + '" placeholder="（例如：2016-01-01）" value="' + n + '" />';
    l += "</div>";
    l += '<div style="clear: both;"></div>';
    l += "</li>";
    if (p == 1) {
        l += '<li class="sex-li" style="display:none;">'
    } else {
        l += '<li class="sex-li">'
    }
    l += '<div class="left">性别</div>';
    l += '<div class="right sex">';
    l += "<label>";
    l += '男 <input id="sexM' + g + '" class="sexRadio radio pd-l-5" type="radio" name="sex' + g + '" value="1"';
    if (j == 1) {
        l += ' checked="checked"'
    }
    l += " />";
    l += "</label>";
    l += "<label>";
    l += '女 <input id="sexW' + g + '" class="sexRadio radio pd-l-5" type="radio" name="sex' + g + '" value="2"';
    if (j == 2) {
        l += ' checked="checked"'
    }
    l += " />";
    l += "</label>";
    l += "</div>";
    l += '<div style="clear: both;"></div>';
    l += "</li>";
    l += '<li><div class="left">电话号码</div>';
    l += '<div class="right"><input oninput="this.value = (this.value.replace(/\\s+/g, \'\'));" onafterpaste="this.value = (this.value.replace(/\\s+/g, \'\'));" id="tel' + g + '" type="text" name="tel' + g + '"placeholder="（必填）" class="mobileInput required" value="' + e + '" ';
    l += '/></div><div style="clear: both;"></div></li>';
    if (isHaveGroup) {
        if (selectOptions != "") {
            l += '<li><div class="left">交通方式</div><div class="right">';
            l += '<input id="go_train_id' + g + '" name="go_train_id' + g + '" type="text" value="' + defaultGoTrainId + '" style="display:none;">';
            l += '<input id="back_train_id' + g + '" name="back_train_id' + g + '" type="text" value="' + defaultBackTrainId + '" style="display:none;">';
            l += '<div class="select">';
            l += '<div class="select-show">';
            l += defaultGroupName;
            l += '<img src="/phone/public/images/wechat/select_arrow.png" width="10">';
            l += "</div>";
            l += '<select id="traffic' + g + '" name="traffic' + g + '" class="traffic" signupNum="' + g + '" selectType="traffic">';
            l += selectOptions;
            l += "</select>";
            l += "</div>";
            l += "</div></li>"
        }
    } else {
        if (selectOptions != "") {
            l += '<li><div class="left">交通方式</div><div class="right">';
            l += '<input id="go_train_id' + g + '" name="go_train_id' + g + '" type="text" value="' + defaultGoTrainId + '" style="display:none;">';
            l += '<input id="back_train_id' + g + '" name="back_train_id' + g + '" type="text" value="' + defaultBackTrainId + '" style="display:none;">';
            l += '<div class="select">';
            l += '<div class="select-show">';
            if (defaultGoTrainTypeName == defaultBackTrainTypeName) {
                l += defaultGoTrainTypeName + "往返 "
            } else {
                l += defaultGoTrainTypeName + " - " + defaultBackTrainTypeName
            }
            if (defaultTicket == 1) {
                l += "(成人)"
            } else {
                if (defaultTicket == 2) {
                    l += "(儿童)"
                }
            }
            l += '<img src="/phone/public/images/wechat/select_arrow.png" width="10">';
            l += "</div>";
            l += '<select id="traffic' + g + '" name="traffic' + g + '" class="traffic" signupNum="' + g + '" selectType="traffic">';
            l += selectOptions;
            l += "</select>";
            l += "</div>";
            l += "</div></li>"
        }
    }
    if (isSingle) {
        l += '<li><div class="left">' + isSingleCommpany + '</div><div class="right"><input id="company' + g + '" type="text" name="company' + g + '" placeholder="（必填）" class="required" ';
        if (mySignInfo) {
            l += ' value="' + k + '" '
        }
        l += ' /></div><div class="clr"></div></li><li><div class="left">' + isSingleJob + '</div><div class="right" ><input type="text" id="job' + g + '" placeholder="（必填）" name="job' + g + '" >'
    }
    if (isHK) {
        l += '<li class="visa-li" style="' + ((p == 4 || p == 6) ? "display:none;" : "") + '"><div class="left">签证类型</div>';
        l += '<div class="right visa"><label>G签 <input id="visag' + g + '" onchange="showPass(this);" data-id="' + g + '" ';
        if (d == 1) {
            l += ' checked="true" '
        }
        l += ' class="visatype visag radio pd-l-5" type="radio" name="visa' + g + '" value="1" /></label>';
        l += '<label>L签 <input id="visal' + g + '" onchange="showPass(this);" data-id="' + g + '"';
        if (d == 2) {
            l += ' checked="true" '
        }
        l += ' class="visatype visal radio pd-l-5" type="radio" name="visa' + g + '" value="2" /></label>';
        if (g == 0) {
            l += '<a class="infobg" data-target="#gl_model" data-toggle="modal"></a>'
        }
        l += "</div>";
        l += '<div style="clear: both;"></div></li>';
        if (d == 2) {
            l += '<div id="lvisa_' + g + '" >'
        } else {
            l += '<div id="lvisa_' + g + '" style="display: none;">'
        }
        l += '<li><div class="left">通行证号码</div><div class="right">';
        l += '<input type="text" class="passNum" id="passNum' + g + '" placeholder="（L签必填）" name="passNum' + g + '" value="' + h + '"  ></div><div class="clr"></div></li>';
        l += '<li><div class="left">签发地</div><div class="right">';
        l += '<input type="text" class="passAddr" id="passAddr' + g + '" placeholder="（L签必填）" name="passAddr' + g + '" value="' + b + '" ></div><div class="clr"></div></li></div>'
    }
    if (care) {
        l += '<li class="careLi haveCheckbox">';
        l += '<div class="pull-left">我是' + careJob + "</div>";
        l += '<div class="pull-left">';
        if (careMoney > 0) {
            l += '<span id="careMoney0" class="green">-' + careMoney + "</span>元"
        }
        l += "</div>";
        l += '<div class="pull-right">';
        l += '<input class="discountCheckbox careJob" type="checkbox" name="careJob' + g + '" id="careJob' + g + '" onchange="showCareImg(this)" isCare="1" value="1"/>';
        l += '<label class="chkbox comChk" for="careJob' + g + '"></label>';
        l += "</div>";
        l += "</li>";
        l += '<li id="careImgDiv' + g + '" class="careImgDiv" style="display: none">';
        l += '<div class="left">凭证</div>';
        l += '<div class="right">';
        l += '<input type="hidden" id="careImg' + g + '" name="careImg' + g + '" value="">';
        l += '<label name="careUploadImg' + g + '"id="careUploadImg' + g + '" class="green" style="text-decoration:underline;" onclick="clickCareImg(this)">上传图片</label>';
        l += "</div>";
        l += '<div class="clr"></div>';
        l += "</li>"
    }
    l += addSignUpsDiscountsLi(g);
    l += "</ul>";
    if (isSingle) {
        l += '<div onclick="reduceMember($(this));" class="add-btn red" style="margin-top: 70px;" >-</div>'
    } else {
        l += '<div onclick="reduceMember($(this));" class="add-btn red" >-</div>'
    }
    l += '<div style="clear: both;"></div>';
    $("#join-num").html(g + 1);
    return l
}

function setDefault(a) {
    var b = {
        contactId: a
    };
    $.ajax({
        type: "post",
        data: b,
        url: "/phone/member/linkman/ajax_contact_default",
        async: false,
        cache: false,
        dataType: "json",
        success: function (c) {
            if (c.status == 1) {
                $(".df").each(function (d, e) {
                    var f = $(e).attr("data-val");
                    $(e).attr("class", "sf green");
                    $(e).attr("onclick", "setDefault(" + f + ")");
                    $(e).html("设为默认")
                });
                $("#sdf_c_" + a).attr("class", "df");
                $("#sdf_c_" + a).removeAttr("onclick");
                $("#sdf_c_" + a).html("默认")
            } else {
                alert(c.msg)
            }
        }
    })
}

function delContact(a) {
    if (confirm("确认删除？")) {
        var b = {
            contactId: a
        };
        console.log(b);
        $.ajax({
            type: "post",
            data: b,
            url: "/phone/member/linkman/ajax_contact_del",
            async: false,
            cache: false,
            dataType: "json",
            success: function (c) {
                if (c.status == 1) {
                    alert(c.msg);
                    $("#li_" + a).remove()
                } else {
                    alert(c.msg)
                }
            }
        })
    }
}

function showPass(b) {
    var a = $(b).val();
    var c = $(b).attr("data-id");
    if (a == 2) {
        $("#lvisa_" + c).show();
        $("#passNum" + c).addClass("required");
        $("#passAddr" + c).addClass("required");
        $("#signUpsLPassCustom" + c).css("display", "inherit");
        $("#signUpsLPassCustom" + c).find(".discountCheckbox").prop("checked", "checked")
    } else {
        $("#passNum" + c).removeClass("required");
        $("#passAddr" + c).removeClass("required");
        $("#lvisa_" + c).hide();
        $("#signUpsLPassCustom" + c).css("display", "none");
        $("#signUpsLPassCustom" + c).find(".discountCheckbox").prop("checked", false)
    }
    countActivityMoney()
}

function getCareNum() {
    num = 0;
    for (i = 0; i < membernum; i++) {
        if ($("#careJob" + i).prop("checked")) {
            num++
        }
    }
    return num
}

function showCareImg(c) {
    var f = $(c).attr("id");
    var a = f.replace("Job", "ImgDiv");
    var b = f.replace("Job", "Img");
    var d = f.replace("Job", "UploadImg");
    if (c.checked) {
        $("#" + a).css("display", "block")
    } else {
        $("#" + a).css("display", "none");
        $("#" + b).val("");
        $("#" + d).html("上传图片")
    }
    price()
}

function clickCareImg(f) {
    var c = $(f);
    var g = c.attr("id");
    var b = g.replace("UploadImg", "Img");
    var d = $("#" + b).val();
    if (d != undefined && d != "") {
        var a = [];
        a.push(d);
        wx.previewImage({
            current: d,
            urls: a
        })
    } else {
        wx.chooseImage({
            success: function (h) {
                var j = h.localIds;
                if (j.length == 1) {
                    function e() {
                        setTimeout(function () {
                                wx.uploadImage({
                                    localId: j[0],
                                    isShowProgressTips: 1,
                                    success: function (k) {
                                        $.ajax({
                                            type: "post",
                                            data: {
                                                wxoid: oid,
                                                serverId: k.serverId
                                            },
                                            url: "/wechat/album/uploadimg",
                                            dataType: "json",
                                            beforeSend: function () {
                                                $(".loading").html("上传中...");
                                                $("#loading").show()
                                            },
                                            success: function (l) {
                                                $(".loading").html("");
                                                $("#loading").hide();
                                                if (l.status == 0) {
                                                    $("#" + b).val(l.imageUrl);
                                                    c.html("查看图片");
                                                    countActivityMoney()
                                                } else {
                                                    alert(l.errmsg)
                                                }
                                            }
                                        })
                                    },
                                    fail: function (k) {
                                    }
                                })
                            },
                            100)
                    }

                    e()
                } else {
                    alert("只能上传一张图片")
                }
            },
            fail: function (e) {
                alert(JSON.stringify(e))
            }
        })
    }
}

function checkCareImg(a) {
    for (i = 0; i < membernum; i++) {
        var a = document.getElementById("#careJob" + i);
        if (a.checked) {
            $("#" + divId).css("display", "block")
        }
    }
}

$(document).on("change", ".select select",
    function (a) {
        var h = $(this).attr("selectType");
        var j = $(this).find(".type" + $(this).val()).html();
        var g = $(this).attr("signupNum");
        $(this).prev().html(j + '<img src="/phone/public/images/wechat/select_arrow.png" width="10">');
        countActivityMoney();
        var f = $(this).parent().parent().parent().parent();
        if (h == "idcardtype") {
            $("#idcard" + g).attr("idType", $(this).val());
            f.find(".child-guardian").remove()
        }
        if (h == "idcardtype" && ($(this).val() == 4 || $(this).val() == 6)) {
            f.find(".visa-li").hide()
        } else {
            f.find(".visa-li").show()
        }
        if ($(this).val() != 1 && $(this).val() != 2 && h == "idcardtype") {
            f.find(".birthday-li").css("display", "inherit");
            f.find(".birthday").addClass("required");
            f.find(".sex-li").css("display", "inherit");
            f.find(".sexRadio").addClass("required");
            $(this).parent().parent().next().find("input[type='text']").val("");
            f.find(".birthday").val("")
        } else {
            if (h != "traffic") {
                f.find(".birthday-li").css("display", "none");
                f.find(".birthday").removeClass("required");
                f.find(".sex-li").css("display", "none");
                f.find(".sexRadio").removeClass("required")
            } else {
                if (h == "traffic") {
                    var b = $("#traffic" + g).val();
                    var e = $("#traffic" + g).find(".type" + b).attr("goid");
                    var d = $("#traffic" + g).find(".type" + b).attr("backid");
                    if (e > 0 && d > 0) {
                        var c = $(this).parent().parent().parent().parent().find(".idcardtype").val();
                        if (c == 6) {
                            popLayer({
                                title: "温馨提示",
                                btnsName: "确认",
                                btnsCallback: "closePopLayer()",
                                content: '<div class="text-center">购买火车票时不能使用其他证件类型，请选择身份证或者护照！</div>',
                            });
                            j = $(this).find(".type0").html();
                            $(this).prev().html(j + '<img src="/phone/public/images/wechat/select_arrow.png" width="10">');
                            countActivityMoney();
                            $(this).val(0);
                            return false
                        }
                    }
                    $("#go_train_id" + g).val("");
                    $("#back_train_id" + g).val("");
                    $("#self_booking_type" + g).val("");
                    $("#go_train_id" + g).val(e);
                    $("#back_train_id" + g).val(d)
                }
            }
        }
    });
$(document).on("click", ".fee-add-btn",
    function (b) {
        var a = parseInt($(this).parent().find(".no-style-input").val());
        a++;
        $(this).parent().find(".no-style-input").val(a);
        $(this).parent().find("label").html(a);
        countActivityMoney()
    });
$(document).on("click", ".fee-del-btn",
    function (b) {
        var a = parseInt($(this).parent().find(".no-style-input").val());
        if (a == 0) {
        } else {
            a--;
            $(this).parent().find(".no-style-input").val(a);
            $(this).parent().find("label").html(a);
            countActivityMoney()
        }
    });
$(document).on("click", ".discountCheckbox",
    function (d) {
        var e = $(this).attr("isdefault");
        var c = $(this).attr("notdefaulttip");
        var b = $(this).is(":checked");
        var a = $(this).attr("id");
        if (e == 1 && !b) {
            popLayer({
                title: "温馨提示",
                btnsName: "保留;取消",
                btnsCallback: "closePopLayerAndKeep(" + a + ");closePopLayer()",
                content: '<div class="text-center">' + c + "</div>",
            })
        }
        countActivityMoney()
    });

function closePopLayerAndKeep(a) {
    closePopLayer();
    $(a).prop("checked", "checked");
    countActivityMoney()
}

function countActivityMoney() {
    var h = 0;
    var q = 0;
    var f = $(".signups").length;
    $("#join-num").html(f);
    if ($("#paytype1:checked").length > 0) {
        h = money * (aliDiscount / 100) * f
    } else {
        h = money * f
    }
    var s = 0;
    $(".vip_discount").each(function (t, u) {
        if ($("#paytype1:checked").length > 0) {
            h -= money * (aliDiscount / 100);
            vip_money = (money - $(this).val()) * (aliDiscount / 100)
        } else {
            h -= money;
            vip_money = money - $(this).val()
        }
        h += vip_money
    });
    var l;
    var g;
    for (var n = 0; n < f; n++) {
        if (selectOptionsLength > 1) {
            l = $("#traffic" + n).val();
            if (l == null) {
                l = 0
            }
            g = parseFloat($("#traffic" + n).find(".type" + l).attr("money") / 100);
            if (isNaN(g)) {
                continue
            }
            if (g < 0) {
                q += g
            }
            h += g
        }
        var d = $(".signups").eq(n).find(".discountCheckbox");
        var k = $("#careImg" + n).val();
        d.each(function (u, v) {
            var t = $(this).attr("isCare");
            if ($(this).is(":checked") && (t != 1 || (t == 1 && k != undefined && k != ""))) {
                var w = parseFloat($(this).parent().prev().find(".green").html());
                if (w < 0) {
                    q += w
                }
                if (!isNaN(w)) {
                    h += w
                }
            }
        })
    }
    var a = $(".fee-items").length;
    $(".fee-items").each(function (t, v) {
        var w = parseFloat($(this).find(".fee-money span").html());
        var u = parseInt($(this).find(".fee-count .fee-num .no-style-input").val());
        h += u * w;
        if (w < 0) {
            q += u * w
        }
    });
    if (haveChildDiscount) {
        var o = 0;
        $(".signups").each(function (v, w) {
            var y = $(this).find(".idcardtype").val();
            if (y == 1) {
                var u = $(this).find(".idCardInput").val();
                var t = checkAgeIsChildByIdcard(u, 1);
                if (t) {
                    o++
                }
            } else {
                if (y == 4 || y == 6) {
                    var x = $(this).find(".birthday").val();
                    var t = checkAgeIsChildByIdcard(x, 2);
                    if (t) {
                        o++
                    }
                }
            }
        });
        $("#child_num").val(o);
        $("#child_num").next().html(o);
        var e = parseFloat($("#childReduceMoney").html());
        h += o * e;
        q += o * e
    }
    if (haveNewUserDiscount) {
        var p = parseInt($("#new_user_num").val());
        var r = parseFloat($("#newUserMoney").html());
        h += p * r;
        q += p * r
    }
    if (haveQuotaLimit) {
        if (quotaLimitNum > 0) {
            var m = parseInt($("#signup_discount_num").val());
            var b = parseFloat($("#signupDiscountMoney").html());
            h += m * b;
            q += m * b
        }
    }
    if (isUseScore) {
        useBalance = 0
        var q = (parseInt(useScore) * scoreExchangeRate + parseInt(useBalance * 100)) / 100;
        h -= q;
        var c = '<span style="color:#9B8CE5;">-' + q + "</span>元";
        if (useScore > 0 && useBalance > 0) {
            c += '(<span style="color:#9B8CE5;">' + useScore + '</span>学分 + <span style="color:#9B8CE5;">' + useBalance + "元</span>零钱)"
        } else {
            if (useScore > 0) {
                c += '(<span style="color:#9B8CE5;">' + useScore + "</span>学分)"
            } else {
                c += '(<span style="color:#9B8CE5;">￥' + useBalance + "元</span>零钱)"
            }
        }
        $("#isUseScore").parent().prev().html(c)
    }
    if (havCutDiscount) {
        var j = parseInt($("#cutDiscountMoney").data("discount")) / 100;
        console.log(j);
        h -= j
    }
    h -= curCardMoney;
    if (h < 0) {
        h = 0
    }
    h = checkNumPoint(h);
    if (h >= 2000 || $("#bankPay").data("needbankpay") == 1) {
        $("#bankPay").show()
    } else {
        $("#bankPay").hide()
    }
    $("#payBtn").data('value', h)
    $("#payBtn").val('￥' + h + '支付')
}

function checkNumPoint(b) {
    var a = b.toString().indexOf(".");
    if (a == -1) {
        return b
    } else {
        return b.toFixed(2)
    }
}

function isIdCardNo(id) {
    // 1 "验证通过!", 0 //校验不通过 // id为身份证号码
    var format = /^(([1][1-5])|([2][1-3])|([3][1-7])|([4][1-6])|([5][0-4])|([6][1-5])|([7][1])|([8][1-2]))\d{4}(([1][9]\d{2})|([2]\d{3}))(([0][1-9])|([1][0-2]))(([0][1-9])|([1-2][0-9])|([3][0-1]))\d{3}[0-9xX]$/;
    //号码规则校验
    if(!format.test(id)){
        return false;
    }
    //区位码校验
    //出生年月日校验  前正则限制起始年份为1900;
    var year = id.substr(6,4),//身份证年
        month = id.substr(10,2),//身份证月
        date = id.substr(12,2),//身份证日
        time = Date.parse(month+'-'+date+'-'+year),//身份证日期时间戳date
        now_time = Date.parse(new Date()),//当前时间戳
        dates = (new Date(year,month,0)).getDate();//身份证当月天数
    if(time>now_time||date>dates){
        return false
    }
    //校验码判断
    var c = new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);  //系数
    var b = new Array('1','0','X','9','8','7','6','5','4','3','2'); //校验码对照表
    var id_array = id.split("");
    var sum = 0;
    for(var k=0;k<17;k++){
        sum+=parseInt(id_array[k])*parseInt(c[k]);
    }
    if(id_array[17].toUpperCase() != b[sum%11].toUpperCase()){
        return false;
    }
    return true;
}

$(document).on("click", '#paytype-ul li[class!="craditLi"][class!="craditLi2"]',
    function (a) {
        if ($(this).attr("id") != "craditPay") {
            $(".craditLi").hide();
            $(".craditLi2").hide()
        }
        $(this).find('input[type="radio"]').prop("checked", "checked");
        $("#paytype-ul li .right label").attr("class", "radio");
        $(this).find(".right label").attr("class", "radio on");
        $("#paytype-ul").css("border", "0");
        countActivityMoney()
    });

function getNewQuotaLimitNum() {
    $.ajax({
        url: "/wechat/pay/getnewquotalimitnum",
        type: "POST",
        dataType: "json",
        data: {
            aid: aid
        },
    }).done(function (a) {
        if (quotaLimitNum != a) {
            quotaLimitNum = a;
            addSignupDiscountNum()
        }
    }).fail(function () {
        reduceSignupDiscountNum();
        countActivityMoney()
    })
}

function addSignupDiscountNum() {
    $("#quotaLimitNum span").html(quotaLimitNum);
    var a = $("#signup_discount_num").val();
    if (quotaLimitNum > 0) {
        if (quotaLimitNum - a > 0) {
            a++;
            $("#signup_discount_num").val(a);
            $("#signup_discount_num").next().html(a)
        } else {
            $("#signup_discount_num").val(quotaLimitNum);
            $("#signup_discount_num").next().html(quotaLimitNum)
        }
    }
    if (quotaLimitNum <= 0) {
        $("#signup_discount_num").val(0);
        $("#signup_discount_num").next().html(0)
    }
    countActivityMoney()
}

function reduceSignupDiscountNum() {
    var b = parseInt($("#join-num").html());
    var a = $("#signup_discount_num").val();
    if (b <= a) {
        a--;
        if (a <= 0) {
            a = 0
        }
        $("#signup_discount_num").val(a);
        $("#signup_discount_num").next().html(a)
    }
}

var visagCheckNum = 0;

function showVisaFeeAbout(b, a) {
    if (b.checked) {
        visagCheckNum++;
        visagClickSignUps.push(a)
    } else {
        $(b).parent().parent().next().find("input").val("");
        $(b).parent().parent().next().find("label").html("上传图片");
        visagCheckNum--;
        visagClickSignUps.remove(a)
    }
    price()
}

function clickVisaImg(f) {
    var c = $(f);
    var g = c.attr("id");
    var b = g.replace("UploadImg", "Img");
    var d = $("#" + b).val();
    if (d != undefined && d != "") {
        var a = [];
        a.push(d);
        wx.previewImage({
            current: d,
            urls: a
        })
    } else {
        wx.chooseImage({
            success: function (h) {
                var j = h.localIds;
                if (j.length == 1) {
                    function e() {
                        setTimeout(function () {
                                wx.uploadImage({
                                    localId: j[0],
                                    isShowProgressTips: 1,
                                    success: function (k) {
                                        $.ajax({
                                            type: "post",
                                            data: {
                                                wxoid: oid,
                                                serverId: k.serverId
                                            },
                                            url: "/wechat/album/uploadimg",
                                            dataType: "json",
                                            beforeSend: function () {
                                                $(".loading").html("上传中...");
                                                $("#loading").show()
                                            },
                                            success: function (l) {
                                                $(".loading").html("");
                                                $("#loading").hide();
                                                if (l.status == 0) {
                                                    $("#" + b).val(l.imageUrl);
                                                    c.html("查看图片");
                                                    countActivityMoney()
                                                } else {
                                                    alert(l.errmsg)
                                                }
                                            }
                                        })
                                    },
                                    fail: function (k) {
                                    }
                                })
                            },
                            100)
                    }

                    e()
                } else {
                    alert("只能上传一张图片")
                }
            },
            fail: function (e) {
                alert(JSON.stringify(e))
            }
        })
    }
}

function showTerms() {
    $("#termsBtns").css("display", "none");
    $("#clickPayTermsBtns").css("display", "inherit");
    $("#pop-layer").css("z-index", "1030");
    $("body").unbind("touchmove");
    $("#termsBtn").click()
}

function closeTerms() {
    $("#termsBtns").css("display", "inherit");
    $("#clickPayTermsBtns").css("display", "none");
    $("#pop-layer").css("z-index", "10000");
    $("body").bind("touchmove",
        function (a) {
            a.preventDefault()
        });
    $("#confirmTermsBtn").click()
}

function agreeTermsAndPay() {
    closePopLayer();
    $("#termsBtns").css("display", "inherit");
    $("#clickPayTermsBtns").css("display", "none");
    $("#pop-layer").css("z-index", "10000");
    $("#terms_model").modal("hide");
    $("#mianze").prop("checked", "checked");
    $("#payBtn").click()
}

function sendWhiteList() {
    closePopLayer();
    $.ajax({
        type: "post",
        data: {
            wxoid: oid,
            aid: aid,
            datas: notFixdata,
        },
        url: "/wechat/activity/sendwhitelist",
        dataType: "json",
        beforeSend: function () {
            $(".loading").html("提交中...");
            $("#loading").show()
        },
        success: function (a) {
            $(".loading").html("");
            $("#loading").hide();
            if (a.status) {
                popLayer({
                    title: "温馨提示",
                    btnsName: "确认",
                    btnsCallback: "closePopLayer()",
                    content: "我们已经收到您的申请，将会尽快处理",
                })
            } else {
                popLayer({
                    title: "温馨提示",
                    btnsName: "返回",
                    btnsCallback: "closePopLayer()",
                    content: a.msg,
                })
            }
        }
    })
}

function showUseScore(b, a) {
    checkedCheckbox(a);
    canUseBalance = 0;
    if (a == 1) {
        useScoreTotalFee = parseFloat($("#payBtn").data('value'));

        popLayer({
            title: '<div class="canUseScore">当前可用学分：' + canUseScore + "</div>",
            btnsName: "取消;使用",
            btnsCallback: "closePopLayer();sureToUse(" + a + ")",
            content: '<div class="useScore"><div class="pull-left" style="width:80%;"><input  disabled="disabled" type="text" placeholder="请输入使用学分" id="useScore"></div><div class="pull-right" style="width:20%;"><button class="use-all-score-btn" type="button" onclick="useAllScore();">全部</button></div><div class="clear"></div></div><div id="show-error"></div><div class="text-center" style="font-size:12px;">可抵扣 <span id="scoreMoney" style="color:#9B8CE5;">0</span> 元，抵扣后不会导致用户等级下降</div>',
        });
        var d = '<div class="useScore"><div class="pull-left" style="width:20%;"><span class="use-all-score-text text-center">学分：</span></div><div class="pull-left" style="width:80%;"><input disabled="disabled" type="text" placeholder="您的可用学分:' + canUseScore + '" id="useScore"></div><div class="clear"></div></div>';
        if (canUseBalance > 0 && hikerRole != 1) {
            d += '<div class="useBalanceBox"><div class="pull-left" style="width:20%;"><span class="use-all-score-text text-center">零钱：</span></div><div class="pull-left" style="width:80%;"><input min="0" max="100" type="text" placeholder="您的可用零钱:' + canUseBalance + '" id="useBalanceIpt"></div><div class="clear"></div></div>'
        }
        d += '<div class="text-center" style="font-size:12px;">可抵扣 <span id="scoreMoney" style="color:#9B8CE5;">0</span> 元，学分抵扣后不会导致用户等级下降</div><div id="show-error"></div>';
        popLayer({
            title: "学分抵扣",
            btnsName: "取消;使用",
            btnsCallback: "closePopLayer();sureToUse(" + a + ")",
            content: d,
        })
        $("#useScore").val(useScore);
        $('#useScore').trigger("change");
        //setDiscountMoney(1)
    } else {
        checkedCheckbox(a)
    }
    // $.ajax({
    //     url: "/wechat/pay/getcanusescore",
    //     type: "POST",
    //     dataType: "json",
    //     data: {
    //         wxoid: wxoid,
    //     },
    // }).done(function(c) {
    //     if (c.status == 1) {
    //         canUseScore = c.canUseScore;
    //         canUseBalance = c.balance;
    //         hikerRole = c.role;
    //         if (a == 1) {
    //             useScoreTotalFee = parseFloat($("#payBtn").data('value'));
    //             popLayer({
    //                 title: '<div class="canUseScore">当前可用学分：' + c.canUseScore + "</div>",
    //                 btnsName: "取消;使用",
    //                 btnsCallback: "closePopLayer();sureToUse(" + a + ")",
    //                 content: '<div class="useScore"><div class="pull-left" style="width:80%;"><input type="text" placeholder="请输入使用学分" id="useScore"></div><div class="pull-right" style="width:20%;"><button class="use-all-score-btn" type="button" onclick="useAllScore();">全部</button></div><div class="clear"></div></div><div id="show-error"></div><div class="text-center" style="font-size:12px;">可抵扣 <span id="scoreMoney" style="color:#9B8CE5;">0</span> 元，抵扣后不会导致用户等级下降</div>',
    //             });
    //             var d = '<div class="useScore"><div class="pull-left" style="width:20%;"><span class="use-all-score-text text-center">学分：</span></div><div class="pull-left" style="width:80%;"><input type="text" placeholder="您的可用学分:' + canUseScore + '" id="useScore"></div><div class="clear"></div></div>';
    //             if (canUseBalance > 0 && hikerRole != 1) {
    //                 d += '<div class="useBalanceBox"><div class="pull-left" style="width:20%;"><span class="use-all-score-text text-center">零钱：</span></div><div class="pull-left" style="width:80%;"><input min="0" max="100" type="text" placeholder="您的可用零钱:' + canUseBalance + '" id="useBalanceIpt"></div><div class="clear"></div></div>'
    //             }
    //             d += '<div class="text-center" style="font-size:12px;">可抵扣 <span id="scoreMoney" style="color:#9B8CE5;">0</span> 元，学分抵扣后不会导致用户等级下降</div><div id="show-error"></div>';
    //             popLayer({
    //                 title: "学分抵扣",
    //                 btnsName: "取消;使用",
    //                 btnsCallback: "closePopLayer();sureToUse(" + a + ")",
    //                 content: d,
    //             })
    //         } else {
    //             checkedCheckbox(a)
    //         }
    //     } else {}
    // }).fail(function() {})
}

function setDiscountMoney(c) {
    var d = parseInt($("#useScore").val()) * scoreExchangeRate;
    var b = parseFloat($("#useBalanceIpt").val()) * 100;
    if (isNaN(d)) {
        d = 0
    }
    if (isNaN(b)) {
        b = 0
    }
    if (b > 10000) {
        $("#useBalanceIpt").val(100);
        $("#show-error").html("零钱最多可抵扣100！");
        showErrorAnimate();
        setDiscountMoney(c);
        return false
    }
    var a = (d + b) / 100;
    $("#scoreMoney").html(a);
    if (a > useScoreTotalFee) {
        if (c == 1) {
            var e = parseInt((useScoreTotalFee * 100 - b) / scoreExchangeRate);
            $("#useScore").val(e);
            $("#show-error").html("使用学分超过总费用！")
        } else {
            var e = parseInt(useScoreTotalFee * 100 - d) / 100;
            $("#useBalanceIpt").val(e);
            $("#show-error").html("使用零钱超过总费用！")
        }
        showErrorAnimate();
        setDiscountMoney(c)
    }
}

$(document).on("input propertychange change focus", "#useScore",
    function () {
        setDiscountMoney(1)
    });
$(document).on("input propertychange change focus", "#useBalanceIpt",
    function () {
        setDiscountMoney(2)
    });

function useAllScore() {
    $("#useScore").val(canUseScore);
    setDiscountMoney(1)
}

function useAllMoney() {
    $("#useBalanceIpt").val(canUseBalance);
    setDiscountMoney(2)
}

function showErrorAnimate() {
    $("#show-error").stop(true, true).animate({
            left: "-10px"
        },
        100).animate({
            left: "10px"
        },
        100).animate({
            left: "-10px"
        },
        100).animate({
            left: "10px"
        },
        100).animate({
            left: "0px"
        },
        100)
}

function sureToUse(c) {
    useScore = $.trim($("#useScore").val());
    console.log(useScore);
    useBalance = $.trim($("#useBalanceIpt").val());
    var a = new RegExp(/^[1-9]\d*$/);
    var b = new RegExp(/^\d*(\.\d{0,2})?$/);
    if (useScore != "" && useScore != 0 && !a.test(useScore)) {
        $("#show-error").html("输入的学分必须为正整数！");
        useScore = 0;
        showErrorAnimate();
        return
    } else {
        useScore = parseInt(useScore);
        if (isNaN(useScore)) {
            useScore = 0
        }
    }
    // if (useBalance != "" && useBalance != 0 && !b.test(useBalance)) {
    //     $("#show-error").html("输入的零钱必须为保留两位小数的正数！");
    //     useBalance = 0;
    //     showErrorAnimate();
    //     return
    // } else {
    //     useBalance = parseFloat(useBalance);
    //     if (isNaN(useBalance)) {
    //         useBalance = 0
    //     }
    // }
    // if (useScore == 0 && useBalance == 0) {
    //     $("#show-error").html("输入使用学分/零钱！");
    //     showErrorAnimate();
    //     return
    // }
    // if (useScore > canUseScore) {
    //     $("#show-error").html("已超过您的可用学分！");
    //     showErrorAnimate();
    //     return
    // }
    // if (useBalance > canUseBalance) {
    //     $("#show-error").html("已超过您的可用零钱！");
    //     showErrorAnimate();
    //     return
    // }
    $("#show-error").html("");
    $("#formUseScore").val(useScore);
    $("#formUseBalance").val(useBalance);
    isUseScore = true;
    countActivityMoney();
    closePopLayer();
    checkedCheckbox(1)
}

function checkedCheckbox(a) {
    if (a == 1) {
        $("#isUseScore").prop("checked", "checked");
        $("#isUseScore").parent().parent().attr("onclick", "showUseScore(this,0)")
    } else {
        isUseScore = false;
        $("#isUseScore").prop("checked", false);
        $("#isUseScore").parent().parent().attr("onclick", "showUseScore(this,1)");
        $("#formUseScore").val(0);
        $("#formUseBalance").val(0);
        $("#isUseScore").parent().prev().html("使用学分");
        countActivityMoney()
    }
}

$(function () {
    $("#craditPay").click(function () {
        craditCheckErr = 1;
        $(".craditLi").show();
        var a = $.trim($("#craditNoIpt").val());
        a = a.replace(/\s/g, "");
        if (a != "" && a == stageCardNoStars) {
            craditCheckErr = 0;
            $(".craditLi2").show()
        }
    });
    $("#showStageRate").click(function () {
        var c = $(this).data("stagebankid");
        var a = $.trim($(this).data("freestages"));
        var b = $.trim($(this).data("freestagename"));
        $.ajax({
            url: "getStageRate",
            type: "POST",
            dataType: "json",
            data: {
                stageBankId: c
            },
        }).done(function (j) {
            if (j.errcode == 0) {
                var g = $("#payBtn").data('value');
                var f = j.errmsg;
                var e = "";
                e += '<table class="table table-hover table-bordered">';
                e += '<caption class="text-left">' + f.bank["name"] + "分期付款费率表</caption>";
                e += "    <thead>";
                e += "        <tr>";
                e += "            <th>分期</th>";
                e += "            <th>费率</th>";
                e += "            <th>手续费(元)</th>";
                e += "        </tr>";
                e += "    </thead>";
                e += "    <tbody>";
                for (var d = 0; d < f.rate.length; d++) {
                    e += "    <tr>";
                    e += "        <td>" + f.rate[d]["stages"] + "</td>";
                    e += "        <td>" + (f.rate[d]["rate"] / 100) + "%</td>";
                    if (a == f.rate[d]["stages"]) {
                        e += '    <td><span style="text-decoration:line-through">' + ((f.rate[d]["rate"] / 10000) * g).toFixed(2) + '</span><span class="green"> ' + b + "</span></td>"
                    } else {
                        e += "    <td>" + ((f.rate[d]["rate"] / 10000) * g).toFixed(2) + "</td>"
                    }
                    e += "    </tr>"
                }
                e += "        <tr>";
                e += '        <td colspan="3">';
                if (f.bank["refund_desc"] != "" && f.bank["refund_desc"] != undefined) {
                    e += "        退款:" + f.bank["refund_desc"] + "<br />"
                }
                e += "            实际手续费和退款规则以银行为准</td>";
                e += "        </tr>";
                e += "    </tbody>";
                e += "</table>";
                $("#stageRateDiv").html(e);
                $("#stageRateModel").modal("show")
            } else {
                showTip($("#craditNoIpt"), j.errmsg)
            }
        }).fail(function () {
            showTip($("#craditNoIpt"), "获取费率失败")
        })
    })
});
var checkCraditBinTime;
var cnf = 1,
    reg = /^\d+$/;
$(document).on("input propertychange change paste", "#craditNoIpt",
    function () {
        craditCheckErr = 1;
        var b = $.trim($(this).val());
        if (b == "") {
            return
        }
        if (cnf == 1 && stageCardNoStars != "") {
            cnf = 0;
            $(this).val("");
            $("#hikerActivityServiceStageIdIpt").val("");
            $(".craditLi2").hide();
            return
        }
        craditNo = b.replace(/\s/g, "");
        if (!craditNo.match(reg)) {
            showTip($("#craditNoIpt"), "银行卡号只能是数字");
            return
        }
        var a = craditNo.length;
        if (a < 4) {
            $(".craditLi2").hide();
            return
        }
        $("#craditNoIpt").val(b);
        replaceCredit(craditNo);
        if (a < 10) {
            $(".craditLi2").hide();
            return
        }
        clearTimeout(checkCraditBinTime);
        checkCraditBinTime = setTimeout(function () {
                checkCraditBin(craditNo)
            },
            100);
        if (a >= 13) {
            craditCheckErr = 0
        }
    });

function checkCredit(d) {
    var a = stringToArray(d);
    a.reverse();
    var b = 0,
        c = 0;
    $.each(a,
        function (e, f) {
            f = parseInt(f);
            if ((e + 1) % 2 == 0) {
                c += ((f * 2) > 9) ? (f * 2 - 9) : (f * 2)
            } else {
                b += f
            }
        });
    if ((c + b) % 10 != 0) {
        showTip($("#craditNoIpt"), "请检查卡号是否正确")
    }
}

replaceCredit();

function replaceCredit(g) {
    var f = 0;
    if (g == undefined) {
        f = 1;
        var g = $.trim($("#craditNoIpt").val())
    }
    g = g.replace(/\s/g, "");
    if (g == "") {
        return
    }
    var a = g.length;
    var e = stringToArray(g);
    if (f == 0 && a <= 4) {
        return
    }
    var d = "",
        b = 1;
    $.each(e,
        function (c, h) {
            b = c + 1;
            d += h;
            if (b % 4 == 0 && b < a) {
                d += " "
            }
        });
    $("#craditNoIpt").val(d);
    return d
}

function stringToArray(a) {
    a = $.trim(a);
    return a.split("")
}

var oldCraditBin = "";

function checkCraditBin(c) {
    var a = c.length;
    var b = c.substr(0, 10);
    if (b != oldCraditBin) {
        if (a < 10) {
            return
        }
        oldCraditBin = b;
        $.ajax({
            url: "checkCraditBin",
            type: "POST",
            dataType: "json",
            data: {
                craditBin: b
            },
        }).done(function (e) {
            if (e.errcode == 0) {
                var d = e.errmsg;
                $("#showStageRate").data("stagebankid", d.id);
                $("#craditBinTip").html(d.name);
                $(".craditLi2").show()
            } else {
                $("#showStageRate").data("stagebankid", "");
                $(".craditLi2").hide()
            }
        }).fail(function () {
            $(".craditLi2").hide();
            $("#showStageRate").data("stagebankid", "");
            showTip($("#craditNoIpt"), "银行卡号信息获取失败")
        })
    }
}

var tipHtml = "";

function showTip(b, a) {
    if (b == undefined || $.type(b) != "object") {
        return false
    }
    var c = "tipCache" + new Date().getTime();
    tipHtml = '<div style="position:relative; opacity:0;" id="' + c + '"><div style="z-index:99;background-color:rgba(0, 0, 0, 0.8);position:absolute;color:#fff;text-align:center;">';
    tipHtml += a;
    tipHtml += "</div></div>";
    b.after(tipHtml);
    $("#" + c + " div").width(b[0].offsetWidth);
    $("#" + c).animate({
            opacity: 1
        },
        400).delay(1000).animate({
            opacity: 0
        },
        400,
        function () {
            $(this).remove()
        })
}

var oldChildrenIdentitys = [];

function checkNeedGuardian(g, h) {
    if (!needCheckGuardian) {
        return false
    }
    var f = $(h).parent().parent().parent();
    var c = f.find(".need_guardian").val();
    var d = f.find(".need_guardian").parent().attr("data-set-index");
    var a = f.find(".idCardInput").val();
    var b = 0;
    if (b >= 18 || b <= 0) {
        f.find(".child-guardian").remove();
        return false
    }
    if (c == 1 && $.inArray(a, oldChildrenIdentitys) != -1) {
        return false
    }
    if (c == 1 && $.inArray(a, oldChildrenIdentitys) == -1) {
        f.find(".child-guardian").remove()
    }
    oldChildrenIdentitys = [];
    $(".idCardInput").each(function (e, k) {
        oldChildrenIdentitys.push($(this).val())
    });
    var j = f.find(".idcardtype").val();
    $.ajax({
        url: "/wechat/order/getdefaultguardian",
        type: "POST",
        dataType: "json",
        data: {
            identity_type: j,
            identity: a
        },
    }).done(function (e) {
        console.log(e);
        setChildGuardianHtml(h, e.realname)
    }).fail(function () {
        console.log("get default guardian data error");
        setChildGuardianHtml(h, false)
    })
}

function setChildGuardianHtml(d, b) {
    var a = $(d).parent().parent().parent();
    var c = "";
    c += '<li class="child-guardian">';
    c += '<div class="left" style="width:50%;">监护人信息</div>';
    c += '<div class="right" style="width:50%;" onclick="showGuardianList(this);" data-set-index="' + (b ? "-2" : "-1") + '">';
    c += "<span>" + (b ? b + "(修改)" : "点击输入") + "</span>";
    c += '<input type="hidden" class="need_guardian" name="need_guardian" value="1">';
    c += "</div>";
    c += "</li>";
    a.append(c)
}

function updateNeedGuardian() {
    $(".idCardInput").each(function (c, d) {
        var f = $(this).parent().parent().parent();
        var a = f.find(".idcardtype").val();
        var b = $(this).val();
        if (b == "") {
            return true
        }
        if (a == 1) {
            var e = b.substr(6, 4) + "-" + b.substr(10, 2) + "-" + b.substr(12, 2);
            checkNeedGuardian(e, this)
        } else {
            var e = f.find(".birthday").val();
            checkNeedGuardian(e, this)
        }
    })
}

function checkVipDiscount(b, h) {
    if (vip_info == undefined) {
        vip_info = false
    }
    if (!vip_info) {
        return false
    }
    var d = false;
    if (b == vip_info.identity) {
        d = vip_info
    }
    if (!d) {
        return false
    }
    var f = $(h).parent().parent().parent();
    if (f.find(".vip-discount").length <= 0) {
        var a = parseInt(money * (1 - d.discount / 100) * 100) / 100;
        var c = f.data("index");
        var g = "";
        g += '<li class="vip-discount">';
        g += '<div class="left" style="width:50%;">' + d.award_name + "</div>";
        g += '<div class="right" style="width:50%;">';
        g += '<span style="color:#3ec77d;">- ' + a + "元</span>";
        g += '<input type="hidden" class="vip_discount" value="' + a + '">';
        g += '<input type="hidden" class="vip_token" name="vip_token' + c + '" value="' + d.vip_token + '">';
        g += "</div>";
        g += "</li>";
        f.append(g)
    }
    countActivityMoney()
}

function updateVipDiscount() {
    $(".idCardInput").each(function (b, c) {
        var a = $(this).val();
        checkVipDiscount(a, this)
    })
}

var freeCustomEle;

function showFreeCustomRules(b) {
    freeCustomEle = b;
    var d = $(b).find(".free-custom-service").is(":checked");
    if (d) {
        $(freeCustomEle).find(".free-custom-service").prop("checked", false)
    } else {
        $(".free-custom-modal").remove();
        var c = $(b).find(".free-desc").html();
        var a = "";
        a += '<div class="free-custom-modal flex-center">';
        a += '<div class="free-custom-bg"></div>';
        a += '<div class="free-custom-main">';
        a += '<div class="free-custom-desc">' + c + "</div>";
        a += '<div class="free-custom-btns flex-div justify-between">';
        a += '<div class="free-custom-btn flex-start" onclick="refundFreeCustom(this);"><span class="faild">不同意</span></div>';
        a += '<div class="free-custom-btn flex-end" onclick="agreeFreeCustom(this);"><span>同意</span></div>';
        a += "</div>";
        a += "</div>";
        a += "</div>";
        $(".content").append(a)
    }
}

function refundFreeCustom(a) {
    $(".free-custom-modal").remove()
}

function agreeFreeCustom(a) {
    $(freeCustomEle).find(".free-custom-service").prop("checked", "checked");
    $(".free-custom-modal").remove()
};